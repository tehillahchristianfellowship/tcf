<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | TCF Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #f4f4f4; padding-bottom: 5rem; }
        .admin-nav { background: var(--dark-bg); color: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; }
        .logout-btn { background: transparent; border: 1px solid white; color: white; padding: 5px 15px; cursor: pointer; }
        
        .admin-container { max-width: 1000px; margin: 2rem auto; padding: 0 20px; }
        .panel { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        
        /* Form Styles */
        .form-grid { display: grid; gap: 1rem; }
        .row { display: flex; gap: 1rem; }
        .col { flex: 1; }
        
        label { font-weight: bold; font-size: 0.9rem; color: #555; margin-bottom: 5px; display: block; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
        
        .add-btn { background: var(--primary-gold); color: white; border: none; padding: 12px 20px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .add-btn:hover { background: #b08d45; }

        /* AI Assistant Box */
        .ai-box {
            background: #e8f0fe; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border: 1px solid #b4c7e7;
        }
        .ai-header { color: #1967d2; margin-top: 0; display: flex; align-items: center; gap: 8px; }
        .ai-input-group { display: flex; gap: 10px; margin-top: 10px; }
        .ai-btn { background: #1967d2; color: white; border: none; padding: 0 20px; cursor: pointer; font-weight: bold; border-radius: 4px; white-space: nowrap;}
        .ai-btn:hover { background: #1557b0; }

        /* List Styles */
        .item-list { margin-top: 1rem; border-top: 1px solid #eee; max-height: 400px; overflow-y: auto; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #eee; }
        .delete-btn { background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .delete-btn:hover { background: #cc0000; }
        
        .item-details { display: flex; flex-direction: column; }
        .item-meta { font-size: 0.85rem; color: #888; }
        .error-msg { color: red; padding: 1rem; background: #ffe6e6; border-radius: 4px; }
        .img-toggle { display: flex; gap: 15px; margin-bottom: 10px; font-size: 0.9rem; }
        .hidden-input { display: none; }
    </style>
</head>
<body>

    <nav class="admin-nav">
        <h3>TCF Admin Panel</h3>
        <button id="logoutBtn" class="logout-btn">Log Out</button>
    </nav>

    <div class="admin-container">
        
        <!-- ANNOUNCEMENTS MANAGER -->
        <div class="panel">
            <h2 style="color: var(--primary-gold); margin-bottom: 1rem;">Post Announcement</h2>
            
            <!-- âœ¨ AI ASSISTANT SECTION âœ¨ -->
            <div class="ai-box">
                <h4 class="ai-header">âœ¨ AI Magic Assistant</h4>
                <p style="font-size:0.9rem; color:#555; margin-bottom:5px;">
                    Type a simple sentence like <em>"Youth bible study next Friday at 6pm bring bibles"</em>
                </p>
                <div class="ai-input-group">
                    <input type="text" id="aiPrompt" placeholder="Describe your announcement here..." style="background:white;">
                    <button type="button" id="btnAiGenerate" class="ai-btn">Auto-Fill</button>
                </div>
                <small id="aiStatus" style="color: #1967d2; font-weight: bold; margin-top: 5px; display: block;"></small>
            </div>
            <!-- END AI SECTION -->

            <form id="announcementForm" class="form-grid">
                <div>
                    <label>Title</label>
                    <input type="text" id="annTitle" placeholder="e.g., Youth Camp Registration" required>
                </div>
                
                <div class="row">
                    <div class="col">
                        <label>Date</label>
                        <input type="date" id="annDate" required>
                    </div>
                    <div class="col">
                        <label>Ministry Group</label>
                        <select id="annMinistry">
                            <option value="Church Wide">Church Wide</option>
                            <option value="Todah Max Mom">Todah Max Mom</option>
                            <option value="Barakong Tatay">Barakong Tatay</option>
                            <option value="Shabach / Halal">Shabach / Halal (Youth)</option>
                            <option value="Yadah Cutie">Yadah Cutie (Kids)</option>
                            <option value="Praise Team">Praise Team</option>
                            <option value="Multimedia">Multimedia</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label>Image Source</label>
                    <div class="img-toggle">
                        <label><input type="radio" name="annImgType" value="link" checked onchange="toggleInput('ann', 'link')"> Link</label>
                        <label><input type="radio" name="annImgType" value="upload" onchange="toggleInput('ann', 'upload')"> Upload File (Disabled)</label>
                    </div>
                    <input type="url" id="annImageLink" placeholder="https://example.com/photo.jpg">
                </div>

                <div>
                    <label>Description</label>
                    <textarea id="annContent" rows="3" placeholder="What is this announcement about?" required></textarea>
                </div>

                <button type="submit" class="add-btn">Post Announcement</button>
            </form>

            <h3 style="margin-top: 2rem;">Manage Announcements</h3>
            <div id="announcementList" class="item-list">
                <p style="padding: 1rem; color: #888;">Loading...</p>
            </div>
        </div>

        <!-- EVENTS MANAGER -->
        <div class="panel">
            <h2 style="color: var(--primary-gold); margin-bottom: 1rem;">Add Event</h2>
            <form id="eventForm" class="form-grid">
                <div>
                    <label>Event Name</label>
                    <input type="text" id="evtTitle" placeholder="e.g., Worship Night" required>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Date</label>
                        <input type="date" id="evtDate" required>
                    </div>
                    <div class="col">
                        <label>Time</label>
                        <input type="time" id="evtTime" required>
                    </div>
                </div>

                <div>
                    <label>Image Link (Optional)</label>
                    <input type="url" id="evtImage" placeholder="https://example.com/banner.jpg">
                </div>

                <div>
                    <label>Description</label>
                    <textarea id="evtDesc" rows="3" placeholder="Event details..." required></textarea>
                </div>

                <button type="submit" class="add-btn">Add Event</button>
            </form>

            <h3 style="margin-top: 2rem;">Event List</h3>
            <div id="eventList" class="item-list">
                <p style="padding: 1rem; color: #888;">Loading...</p>
            </div>
        </div>

    </div>

    <script>
        function toggleInput(prefix, type) {
            // kept simple for link-only mode
            if(type === 'upload') alert("Upload requires billing. Please stick to links for free hosting!");
        }
    </script>

    <script type="module">
        import { auth, db, signOut, onAuthStateChanged, collection, addDoc, query, onSnapshot, deleteDoc, doc } from './firebase-config.js';

        // 1. Auth Check
        onAuthStateChanged(auth, (user) => {
            if (!user) { window.location.href = "login.html"; }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "login.html");
        });

        // --- HELPER: FORMATS ---
        function formatDateReadable(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }
        function formatTime12Hour(timeString) {
            if (!timeString) return "";
            let [hours, minutes] = timeString.split(':');
            hours = parseInt(hours);
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12; 
            return `${hours}:${minutes} ${ampm}`;
        }
        function getMonthAndDay(dateString) {
            const parts = dateString.split('-'); 
            const localDate = new Date(parts[0], parts[1]-1, parts[2]);
            return {
                month: localDate.toLocaleDateString('en-US', { month: 'short' }).toUpperCase(),
                day: String(localDate.getDate()).padStart(2, '0')
            };
        }

        // ==========================================
        // âœ¨ AI MAGIC FUNCTION âœ¨
        // ==========================================
        document.getElementById('btnAiGenerate').addEventListener('click', async () => {
            const prompt = document.getElementById('aiPrompt').value;
            const status = document.getElementById('aiStatus');
            
            if(!prompt) {
                alert("Please type something first!");
                return;
            }
            
            status.innerText = "ðŸ¤– AI is thinking...";
            
            // ---------------------------------------------------------
            // YOUR KEY (Do not share publicly)
            const API_KEY = "AIzaSyCdtsqgR9tfI8iURLHKuwValwLkoiqEdSc"; 
            // ---------------------------------------------------------

            const systemPrompt = `
                You are an assistant for a church. Extract details from the user text and return a strict JSON object (no markdown).
                Current Year: ${new Date().getFullYear()}
                Fields:
                - title (short catchy title)
                - date (YYYY-MM-DD format)
                - ministry (Guess the ministry based on context. Options: "Church Wide", "Todah Max Mom", "Barakong Tatay", "Shabach / Halal", "Yadah Cutie", "Praise Team", "Multimedia". Default to "Church Wide")
                - content (A warm, inviting description based on the text)
                
                User Text: "${prompt}"
            `;

            try {
                // FIXED: Changed to 'gemini-pro' which is the stable model for this API version
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
                });
                
                const data = await response.json();
                
                if(data.error) {
                    throw new Error(data.error.message);
                }

                let textResponse = data.candidates[0].content.parts[0].text;
                // Clean cleanup potential markdown code blocks
                textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const result = JSON.parse(textResponse);
                
                // Populate Form
                document.getElementById('annTitle').value = result.title || "";
                document.getElementById('annDate').value = result.date || "";
                document.getElementById('annMinistry').value = result.ministry || "Church Wide";
                document.getElementById('annContent').value = result.content || "";
                
                status.innerText = "âœ… Done! Review and click Post.";
            } catch(err) {
                console.error(err);
                if (err.message.includes("429") || err.message.includes("Quota")) {
                    status.innerText = "âš ï¸ Quota Exceeded. Please wait a minute.";
                } else if (err.message.includes("not found")) {
                    status.innerText = "âš ï¸ Model Error. Try again later.";
                } else {
                    status.innerText = "âŒ Error: " + err.message;
                }
            }
        });

        // 2. ADD ANNOUNCEMENT
        document.getElementById('announcementForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Posting...";
            
            try {
                const dateVal = document.getElementById('annDate').value;
                const formattedDate = formatDateReadable(dateVal); 
                const imgLink = document.getElementById('annImageLink').value;

                await addDoc(collection(db, "announcements"), {
                    title: document.getElementById('annTitle').value,
                    dateStr: formattedDate,
                    ministry: document.getElementById('annMinistry').value,
                    content: document.getElementById('annContent').value,
                    imageUrl: imgLink, 
                    createdAt: Date.now()
                });
                e.target.reset();
                alert("Announcement Posted!");
            } catch (err) { console.error(err); alert("Error: " + err.message); }
            btn.innerText = originalText;
        });

        // 3. ADD EVENT
        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Adding...";
            
            try {
                const dateVal = document.getElementById('evtDate').value;
                const timeVal = document.getElementById('evtTime').value;
                const dateParts = getMonthAndDay(dateVal); 
                const timeFormatted = formatTime12Hour(timeVal);
                const imgLink = document.getElementById('evtImage').value;

                await addDoc(collection(db, "events"), {
                    title: document.getElementById('evtTitle').value,
                    month: dateParts.month,
                    day: dateParts.day,
                    time: timeFormatted,
                    desc: document.getElementById('evtDesc').value,
                    imageUrl: imgLink,
                    createdAt: Date.now()
                });
                e.target.reset();
                alert("Event Added!");
            } catch (err) { console.error(err); alert("Error: " + err.message); }
            btn.innerText = originalText;
        });

        // 4. LOAD LISTS (Realtime)
        const qAnn = query(collection(db, "announcements"));
        onSnapshot(qAnn, (snapshot) => {
            const list = document.getElementById('announcementList');
            list.innerHTML = "";
            if (snapshot.empty) { list.innerHTML = "<p style='padding:1rem'>No announcements yet.</p>"; return; }

            let items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

            items.forEach(data => {
                const div = document.createElement('div');
                div.className = "list-item";
                div.innerHTML = `
                    <div class="item-details">
                        <strong>${data.title}</strong>
                        <span class="item-meta">${data.ministry} | ${data.dateStr}</span>
                    </div>
                    <button class="delete-ann-btn delete-btn" data-id="${data.id}">Delete</button>
                `;
                list.appendChild(div);
            });
            
            document.querySelectorAll('.delete-ann-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if(confirm("Delete this?")) await deleteDoc(doc(db, "announcements", e.target.dataset.id));
                });
            });
        }, (err) => document.getElementById('announcementList').innerHTML = `<p class="error-msg">${err.message}</p>`);
        
        const qEvt = query(collection(db, "events"));
        onSnapshot(qEvt, (snapshot) => {
            const list = document.getElementById('eventList');
            list.innerHTML = "";
            if (snapshot.empty) { list.innerHTML = "<p style='padding:1rem'>No events found.</p>"; return; }

            let items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

            items.forEach(data => {
                const div = document.createElement('div');
                div.className = "list-item";
                div.innerHTML = `
                    <div class="item-details">
                        <strong>${data.title}</strong>
                        <span class="item-meta">${data.month} ${data.day} | ${data.time}</span>
                    </div>
                    <button class="delete-evt-btn delete-btn" data-id="${data.id}">Delete</button>
                `;
                list.appendChild(div);
            });
            
            document.querySelectorAll('.delete-evt-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if(confirm("Delete this event?")) await deleteDoc(doc(db, "events", e.target.dataset.id));
                });
            });
        }, (err) => document.getElementById('eventList').innerHTML = `<p class="error-msg">${err.message}</p>`);

    </script>
</body>
</html>
