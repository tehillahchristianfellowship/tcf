<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | TCF Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* CRITICAL: Body is hidden by default. Only JS can reveal it. */
        body { background: #f4f4f4; padding-bottom: 5rem; display: none; }
        
        /* Loading Screen Style */
        #authLoading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f4f4f4; display: flex; justify-content: center; align-items: center;
            font-family: 'Lato', sans-serif; color: #555; z-index: 9999;
        }

        .admin-nav { background: var(--dark-bg); color: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; }
        .logout-btn { background: transparent; border: 1px solid white; color: white; padding: 5px 15px; cursor: pointer; }
        
        .admin-container { max-width: 1000px; margin: 2rem auto; padding: 0 20px; }
        .panel { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        
        /* Form Styles */
        .form-grid { display: grid; gap: 1rem; }
        .row { display: flex; gap: 1rem; }
        .col { flex: 1; }
        
        label { font-weight: bold; font-size: 0.9rem; color: #555; margin-bottom: 5px; display: block; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
        
        .add-btn { background: var(--primary-gold); color: white; border: none; padding: 12px 20px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; transition: background 0.3s; }
        .add-btn:hover { background: #b08d45; }
        .cancel-btn { background: #999; margin-left: 10px; display: none; } /* Hidden by default */

        /* AI Assistant Box */
        .ai-box {
            background: #e8f0fe; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border: 1px solid #b4c7e7;
        }
        .ai-header { color: #1967d2; margin-top: 0; display: flex; align-items: center; gap: 8px; }
        .ai-input-group { display: flex; gap: 10px; margin-top: 10px; }
        .ai-btn { background: #1967d2; color: white; border: none; padding: 0 20px; cursor: pointer; font-weight: bold; border-radius: 4px; white-space: nowrap;}
        .ai-btn:hover { background: #1557b0; }

        /* List Styles */
        .item-list { margin-top: 1rem; border-top: 1px solid #eee; max-height: 400px; overflow-y: auto; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #eee; }
        
        .action-btns { display: flex; gap: 5px; }
        .btn-sm { color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .delete-btn { background: #ff4444; }
        .delete-btn:hover { background: #cc0000; }
        .edit-btn { background: #448aff; }
        .edit-btn:hover { background: #005ecb; }
        
        .item-details { display: flex; flex-direction: column; }
        .item-meta { font-size: 0.85rem; color: #888; }
        .error-msg { color: red; padding: 1rem; background: #ffe6e6; border-radius: 4px; }
        .img-toggle { display: flex; gap: 15px; margin-bottom: 10px; font-size: 0.9rem; }
        .hidden-input { display: none; }
        
        /* Gallery Preview */
        .preview-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 10px; }
        .list-item-content { display: flex; align-items: center; }
    </style>
</head>
<body>

    <!-- AUTH LOADING SCREEN -->
    <div id="authLoading">
        <h2>Verifying Access...</h2>
    </div>

    <!-- MAIN CONTENT (Hidden until login confirmed) -->
    <div id="adminContent">
        <nav class="admin-nav">
            <h3>TCF Admin Panel</h3>
            <button id="logoutBtn" class="logout-btn">Log Out</button>
        </nav>

        <div class="admin-container">
            
            <!-- GALLERY MANAGER -->
            <div class="panel">
                <h2 style="color: var(--primary-gold); margin-bottom: 1rem;">Gallery Manager</h2>
                <form id="galleryForm" class="form-grid">
                    <div>
                        <label>Caption</label>
                        <input type="text" id="galCaption" placeholder="e.g., Youth Camp 2026" required>
                    </div>
                    <div>
                        <label>Select Image</label>
                        <input type="file" id="galFile" accept="image/*" required>
                        <small style="color: #888;">Max size: 1MB</small>
                    </div>
                    <button type="submit" class="add-btn">Upload to Gallery</button>
                </form>
                <h3 style="margin-top: 2rem;">Manage Gallery</h3>
                <div id="galleryList" class="item-list">
                    <p style="padding: 1rem; color: #888;">Loading...</p>
                </div>
            </div>

            <!-- ANNOUNCEMENTS MANAGER -->
            <div class="panel">
                <h2 style="color: var(--primary-gold); margin-bottom: 1rem;">Announcements</h2>
                
                <!-- âœ¨ AI ASSISTANT SECTION âœ¨ -->
                <div class="ai-box">
                    <h4 class="ai-header">âœ¨ AI Magic Assistant</h4>
                    <p style="font-size:0.9rem; color:#555; margin-bottom:5px;">
                        Type a simple sentence like <em>"Youth bible study next Friday at 6pm bring bibles"</em>
                    </p>
                    <div class="ai-input-group">
                        <input type="text" id="aiPrompt" placeholder="Describe your announcement here..." style="background:white;">
                        <button type="button" id="btnAiGenerate" class="ai-btn">Auto-Fill</button>
                    </div>
                    <small id="aiStatus" style="color: #1967d2; font-weight: bold; margin-top: 5px; display: block;"></small>
                </div>
                <!-- END AI SECTION -->

                <form id="announcementForm" class="form-grid">
                    <input type="hidden" id="annEditId"> <!-- Hidden ID for Editing -->
                    <div>
                        <label>Title</label>
                        <input type="text" id="annTitle" placeholder="e.g., Youth Camp Registration" required>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>Date (Text or Picker)</label>
                            <!-- Changed to text to allow flexible input like "Every Sunday" or specific dates -->
                            <input type="text" id="annDate" placeholder="e.g., Every Friday or Jan 24, 2026">
                        </div>
                        <div class="col">
                            <label>Ministry Group</label>
                            <select id="annMinistry">
                                <option value="Church Wide">Church Wide</option>
                                <option value="Todah Max Mom">Todah Max Mom</option>
                                <option value="Barakong Tatay">Barakong Tatay</option>
                                <option value="Shabach / Halal">Shabach / Halal (Youth)</option>
                                <option value="Yadah Cutie">Yadah Cutie (Kids)</option>
                                <option value="Praise Team">Praise Team</option>
                                <option value="Multimedia">Multimedia</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label>Image Link (Optional)</label>
                        <input type="url" id="annImageLink" placeholder="https://example.com/photo.jpg">
                    </div>
                    <div>
                        <label>Description</label>
                        <textarea id="annContent" rows="3" placeholder="What is this announcement about?" required></textarea>
                    </div>
                    <div style="display:flex;">
                        <button type="submit" id="annSubmitBtn" class="add-btn">Post Announcement</button>
                        <button type="button" id="annCancelBtn" class="add-btn cancel-btn" onclick="resetAnnForm()">Cancel Edit</button>
                    </div>
                </form>
                <h3 style="margin-top: 2rem;">Manage Announcements</h3>
                <div id="announcementList" class="item-list">
                    <p style="padding: 1rem; color: #888;">Loading...</p>
                </div>
            </div>

            <!-- EVENTS MANAGER -->
            <div class="panel">
                <h2 style="color: var(--primary-gold); margin-bottom: 1rem;">Events</h2>
                <form id="eventForm" class="form-grid">
                    <input type="hidden" id="evtEditId"> <!-- Hidden ID for Editing -->
                    <div>
                        <label>Event Name</label>
                        <input type="text" id="evtTitle" placeholder="e.g., Worship Night" required>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>Date (Flexible)</label>
                            <input type="text" id="evtDate" placeholder="e.g., Every Monday or 2026-02-15">
                        </div>
                        <div class="col">
                            <label>Time (Flexible)</label>
                            <!-- Changed type="time" to type="text" for flexibility -->
                            <input type="text" id="evtTime" placeholder="e.g., 8:00 AM - 10:00 AM">
                        </div>
                    </div>
                    <div>
                        <label>Image Link (Optional)</label>
                        <input type="url" id="evtImage" placeholder="https://example.com/banner.jpg">
                    </div>
                    <div>
                        <label>Description</label>
                        <textarea id="evtDesc" rows="3" placeholder="Event details..." required></textarea>
                    </div>
                    <div style="display:flex;">
                        <button type="submit" id="evtSubmitBtn" class="add-btn">Add Event</button>
                        <button type="button" id="evtCancelBtn" class="add-btn cancel-btn" onclick="resetEvtForm()">Cancel Edit</button>
                    </div>
                </form>
                <h3 style="margin-top: 2rem;">Event List</h3>
                <div id="eventList" class="item-list">
                    <p style="padding: 1rem; color: #888;">Loading...</p>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        // FIX: Import Firebase directly from CDN to avoid relative path errors in some environments
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Your Web App's Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBIXy1hHTjde62hjbLw3nwxMNSCY7HFGns",
            authDomain: "tehillah-website-9dd14.firebaseapp.com",
            projectId: "tehillah-website-9dd14",
            storageBucket: "tehillah-website-9dd14.firebasestorage.app",
            messagingSenderId: "40546309853",
            appId: "1:40546309853:web:4222b7887f6b86ec2e6d34",
            measurementId: "G-MSERH232QZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // 1. AUTH CHECK
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authLoading').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
            } else {
                window.location.replace("login.html"); 
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "login.html");
        });

        // --- HELPER: FORMATS (Updated for flexible inputs) ---
        // If user types a real date (2026-01-01), format it nicely. If they type text ("Every Monday"), keep it.
        function formatFlexibleDate(input) {
            if (!input) return "";
            // Check if input looks like YYYY-MM-DD
            if (input.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(input).toLocaleDateString('en-US', options);
            }
            return input; // Return text as is
        }

        // For getting Month/Day for the calendar icon box
        function getMonthAndDay(input) {
            // Try to parse as date first
            const date = new Date(input);
            if (!isNaN(date.getTime())) {
                return {
                    month: date.toLocaleDateString('en-US', { month: 'short' }).toUpperCase(),
                    day: String(date.getDate()).padStart(2, '0')
                };
            }
            // If text (e.g. "Every Sunday"), just return generic or partial
            return { month: "EVT", day: "ðŸ“…" }; 
        }

        // --- HELPER: CONVERT FILE TO BASE64 ---
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // ==========================================
        // âœ¨ AI MAGIC FUNCTION âœ¨
        // ==========================================
        document.getElementById('btnAiGenerate').addEventListener('click', async () => {
            const prompt = document.getElementById('aiPrompt').value;
            const status = document.getElementById('aiStatus');
            
            if(!prompt) {
                alert("Please type something first!");
                return;
            }
            
            status.innerText = "ðŸ¤– AI is thinking...";
            
            // ---------------------------------------------------------
            // PLACE YOUR GEMINI API KEY HERE
            const API_KEY = "AIzaSyCdtsqgR9tfI8iURLHKuwValwLkoiqEdSc"; 
            // ---------------------------------------------------------

            if(!API_KEY || API_KEY.includes("YOUR_")) {
                status.innerText = "";
                alert("Please edit admin.html code and paste your Gemini API Key.");
                return;
            }

            const systemPrompt = `
                You are an assistant for a church. Extract details from the user text and return a strict JSON object (no markdown).
                Current Year: ${new Date().getFullYear()}
                Fields:
                - title (short catchy title)
                - date (YYYY-MM-DD format)
                - ministry (Guess the ministry based on context. Options: "Church Wide", "Todah Max Mom", "Barakong Tatay", "Shabach / Halal", "Yadah Cutie", "Praise Team", "Multimedia". Default to "Church Wide")
                - content (A warm, inviting description based on the text)
                
                User Text: "${prompt}"
            `;

            try {
                // FIXED: Using 'gemini-pro' which is widely supported
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
                });
                
                const data = await response.json();
                
                if(data.error) {
                    throw new Error(data.error.message);
                }

                let textResponse = data.candidates[0].content.parts[0].text;
                // Clean cleanup potential markdown code blocks
                textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const result = JSON.parse(textResponse);
                
                // Populate Form
                document.getElementById('annTitle').value = result.title || "";
                document.getElementById('annDate').value = result.date || "";
                document.getElementById('annMinistry').value = result.ministry || "Church Wide";
                document.getElementById('annContent').value = result.content || "";
                
                status.innerText = "âœ… Done! Review and click Post.";
            } catch(err) {
                console.error(err);
                if (err.message.includes("429") || err.message.includes("Quota")) {
                    status.innerText = "âš ï¸ Quota Exceeded. Please wait a minute.";
                } else if (err.message.includes("not found")) {
                    status.innerText = "âš ï¸ Model Error. Try again later.";
                } else {
                    status.innerText = "âŒ Error: " + err.message;
                }
            }
        });

        // 1. ADD TO GALLERY
        document.getElementById('galleryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            const fileInput = document.getElementById('galFile');
            
            if (fileInput.files.length === 0) return;
            const file = fileInput.files[0];
            if (file.size > 1048576) { alert("File is too large! Max 1MB."); return; }

            btn.innerText = "Uploading...";
            try {
                const base64String = await toBase64(file);
                await addDoc(collection(db, "gallery"), {
                    caption: document.getElementById('galCaption').value,
                    imageData: base64String, 
                    createdAt: Date.now()
                });
                e.target.reset();
                alert("Image uploaded!");
            } catch (err) { console.error(err); alert("Error: " + err.message); }
            btn.innerText = originalText;
        });

        // 2. ADD / EDIT ANNOUNCEMENT
        document.getElementById('announcementForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('annSubmitBtn');
            const originalText = btn.innerText;
            btn.innerText = "Saving...";
            
            try {
                const id = document.getElementById('annEditId').value;
                const rawDate = document.getElementById('annDate').value;
                const displayDate = formatFlexibleDate(rawDate);

                const data = {
                    title: document.getElementById('annTitle').value,
                    dateStr: displayDate, // Stores formatted or raw text
                    ministry: document.getElementById('annMinistry').value,
                    content: document.getElementById('annContent').value,
                    imageUrl: document.getElementById('annImageLink').value,
                    createdAt: Date.now()
                };

                if (id) {
                    // Update existing
                    await updateDoc(doc(db, "announcements", id), data);
                    alert("Announcement Updated!");
                    window.resetAnnForm(); // Clear edit mode
                } else {
                    // Create new
                    await addDoc(collection(db, "announcements"), data);
                    alert("Announcement Posted!");
                    e.target.reset();
                }
            } catch (err) { console.error(err); alert("Error: " + err.message); }
            btn.innerText = originalText;
        });

        // 3. ADD / EDIT EVENT
        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('evtSubmitBtn');
            const originalText = btn.innerText;
            btn.innerText = "Saving...";
            
            try {
                const id = document.getElementById('evtEditId').value;
                const rawDate = document.getElementById('evtDate').value;
                const dateParts = getMonthAndDay(rawDate); // Calculate calendar icon text

                const data = {
                    title: document.getElementById('evtTitle').value,
                    month: dateParts.month,
                    day: dateParts.day,
                    time: document.getElementById('evtTime').value, // Allows flexible text
                    desc: document.getElementById('evtDesc').value,
                    imageUrl: document.getElementById('evtImage').value,
                    createdAt: Date.now()
                };

                if (id) {
                    await updateDoc(doc(db, "events", id), data);
                    alert("Event Updated!");
                    window.resetEvtForm();
                } else {
                    await addDoc(collection(db, "events"), data);
                    alert("Event Added!");
                    e.target.reset();
                }
            } catch (err) { console.error(err); alert("Error: " + err.message); }
            btn.innerText = originalText;
        });

        // 4. LOAD DATA & HANDLE ACTIONS (Edit/Delete)
        
        // -- Gallery --
        onSnapshot(query(collection(db, "gallery")), (snapshot) => {
            const list = document.getElementById('galleryList');
            list.innerHTML = "";
            if (snapshot.empty) { list.innerHTML = "<p style='padding:1rem'>No photos yet.</p>"; return; }
            
            let items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            items.sort((a, b) => b.createdAt - a.createdAt);

            items.forEach(data => {
                const div = document.createElement('div');
                div.className = "list-item";
                div.innerHTML = `
                    <div class="list-item-content">
                        <img src="${data.imageData}" class="preview-img">
                        <div class="item-details"><strong>${data.caption}</strong></div>
                    </div>
                    <button class="btn-sm delete-btn" onclick="deleteItem('gallery', '${data.id}')">Delete</button>
                `;
                list.appendChild(div);
            });
        });

        // -- Announcements --
        onSnapshot(query(collection(db, "announcements")), (snapshot) => {
            const list = document.getElementById('announcementList');
            list.innerHTML = "";
            if (snapshot.empty) { list.innerHTML = "<p style='padding:1rem'>No announcements.</p>"; return; }

            let items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            items.sort((a, b) => b.createdAt - a.createdAt);

            items.forEach(data => {
                const div = document.createElement('div');
                div.className = "list-item";
                // JSON.stringify helps pass the data object to the edit function safely
                const dataString = JSON.stringify(data).replace(/"/g, '&quot;'); 
                div.innerHTML = `
                    <div class="item-details">
                        <strong>${data.title}</strong>
                        <span class="item-meta">${data.ministry} | ${data.dateStr}</span>
                    </div>
                    <div class="action-btns">
                        <button class="btn-sm edit-btn" onclick="editAnnouncement(${dataString})">Edit</button>
                        <button class="btn-sm delete-btn" onclick="deleteItem('announcements', '${data.id}')">Delete</button>
                    </div>
                `;
                list.appendChild(div);
            });
        });

        // -- Events --
        onSnapshot(query(collection(db, "events")), (snapshot) => {
            const list = document.getElementById('eventList');
            list.innerHTML = "";
            if (snapshot.empty) { list.innerHTML = "<p style='padding:1rem'>No events.</p>"; return; }

            let items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            items.sort((a, b) => b.createdAt - a.createdAt);

            items.forEach(data => {
                const div = document.createElement('div');
                div.className = "list-item";
                const dataString = JSON.stringify(data).replace(/"/g, '&quot;');
                div.innerHTML = `
                    <div class="item-details">
                        <strong>${data.title}</strong>
                        <span class="item-meta">${data.time}</span>
                    </div>
                    <div class="action-btns">
                        <button class="btn-sm edit-btn" onclick="editEvent(${dataString})">Edit</button>
                        <button class="btn-sm delete-btn" onclick="deleteItem('events', '${data.id}')">Delete</button>
                    </div>
                `;
                list.appendChild(div);
            });
        });

        // --- GLOBAL FUNCTIONS FOR BUTTONS ---
        
        window.deleteItem = async function(col, id) {
            if(confirm("Are you sure you want to delete this?")) {
                await deleteDoc(doc(db, col, id));
            }
        };

        // Edit Announcement Logic
        window.editAnnouncement = function(data) {
            document.getElementById('annEditId').value = data.id;
            document.getElementById('annTitle').value = data.title;
            document.getElementById('annDate').value = data.dateStr;
            document.getElementById('annMinistry').value = data.ministry;
            document.getElementById('annImageLink').value = data.imageUrl || "";
            document.getElementById('annContent').value = data.content;
            
            // Change Button State
            document.getElementById('annSubmitBtn').innerText = "Update Announcement";
            document.getElementById('annCancelBtn').style.display = "inline-block";
            window.scrollTo(0, document.getElementById('announcementForm').offsetTop);
        };

        window.resetAnnForm = function() {
            document.getElementById('announcementForm').reset();
            document.getElementById('annEditId').value = "";
            document.getElementById('annSubmitBtn').innerText = "Post Announcement";
            document.getElementById('annCancelBtn').style.display = "none";
        };

        // Edit Event Logic
        window.editEvent = function(data) {
            document.getElementById('evtEditId').value = data.id;
            document.getElementById('evtTitle').value = data.title;
            // We can't perfectly reconstruct the raw date input if we only saved "JAN", 
            // but we can put the time back. For date, user might need to re-enter if they want to change it cleanly.
            // Or just put the flexible string back if possible.
            document.getElementById('evtDate').value = ""; // Clear for safety or put logic to guess
            document.getElementById('evtTime').value = data.time;
            document.getElementById('evtImage').value = data.imageUrl || "";
            document.getElementById('evtDesc').value = data.desc;

            document.getElementById('evtSubmitBtn').innerText = "Update Event";
            document.getElementById('evtCancelBtn').style.display = "inline-block";
            window.scrollTo(0, document.getElementById('eventForm').offsetTop);
        };

        window.resetEvtForm = function() {
            document.getElementById('eventForm').reset();
            document.getElementById('evtEditId').value = "";
            document.getElementById('evtSubmitBtn').innerText = "Add Event";
            document.getElementById('evtCancelBtn').style.display = "none";
        };

    </script>
</body>
</html>
